#!/bin/bash
# ============================================================================
# POWER BOOST OPTIMIZER - CONFIGURATION FILE
# ============================================================================
# High-Performance Workstation Tuning for Linux Mint 22.2
# Target: Intel i7-13700 (24 threads) + NVIDIA RTX 3070 (8GB VRAM)
# ============================================================================

# ----------------------------------------------------------------------------
# DETECTION THRESHOLDS
# ----------------------------------------------------------------------------

# VRAM usage threshold in MB to trigger Boost Mode (default: 1500 = 1.5GB)
VRAM_THRESHOLD_MB=1500

# GPU utilization percentage threshold (0-100)
GPU_UTIL_THRESHOLD=20

# Combined trigger: If EITHER threshold is exceeded, Boost Mode activates
# Set to "AND" to require BOTH thresholds (more conservative)
TRIGGER_LOGIC="OR"

# Polling interval in seconds (lower = more responsive, higher = less CPU overhead)
POLL_INTERVAL=3

# Hysteresis: seconds to wait below threshold before switching to Silent Mode
# Prevents rapid mode oscillation during intermittent workloads
COOLDOWN_SECONDS=30

# ----------------------------------------------------------------------------
# CPU GOVERNOR SETTINGS
# ----------------------------------------------------------------------------

# Governor for Boost Mode (performance | schedutil)
BOOST_GOVERNOR="performance"

# Governor for Silent Mode (powersave | schedutil | conservative)
SILENT_GOVERNOR="schedutil"

# Energy Performance Preference for Boost Mode
# Options: performance | balance_performance | balance_power | power
BOOST_EPP="performance"

# Energy Performance Preference for Silent Mode
SILENT_EPP="balance_power"

# ----------------------------------------------------------------------------
# PROCESS PRIORITY TUNING
# ----------------------------------------------------------------------------

# Automatically renice detected heavy processes to this value (-20 to 19)
# Lower = higher priority. -10 is aggressive but safe.
BOOST_NICE_LEVEL=-10

# Process names to watch for (space-separated, partial match supported)
# These get auto-reniced when detected with high resource usage
HEAVY_PROCESS_PATTERNS="ollama llama python3 resolve ffmpeg blender davinci cuda vllm"

# Minimum CPU% a process must use to be considered "heavy" (for renicing)
CPU_PERCENT_THRESHOLD=15

# ----------------------------------------------------------------------------
# NVIDIA GPU SETTINGS
# ----------------------------------------------------------------------------

# Enable GPU persistence mode in Boost Mode (reduces driver init latency)
# 1 = enable, 0 = disable
GPU_PERSISTENCE_MODE=1

# Maximum GPU power limit in Watts (check your card's max with nvidia-smi -q)
# RTX 3070 typical max: 220-240W depending on model
GPU_MAX_POWER_LIMIT=220

# Default/Silent GPU power limit in Watts (for efficiency)
GPU_SILENT_POWER_LIMIT=115

# Lock GPU clocks during Boost Mode (reduces frequency hunting)
# Set to max stable clocks for your card (nvidia-smi -q -d SUPPORTED_CLOCKS)
GPU_BOOST_CLOCK_MIN=1500
GPU_BOOST_CLOCK_MAX=1950

# ----------------------------------------------------------------------------
# MEMORY & KERNEL TUNING
# ----------------------------------------------------------------------------

# Swappiness: How aggressively to use swap (0-100, lower = prefer RAM)
BOOST_SWAPPINESS=10
SILENT_SWAPPINESS=60

# Dirty ratio: % of RAM that can be dirty before forced writeback
BOOST_DIRTY_RATIO=40
SILENT_DIRTY_RATIO=20

# Dirty background ratio: % of RAM before background writeback starts
BOOST_DIRTY_BG_RATIO=10
SILENT_DIRTY_BG_RATIO=5

# Transparent Hugepages: always | madvise | never
# "always" benefits LLM inference; "madvise" is safer for mixed workloads
BOOST_THP="always"
SILENT_THP="madvise"

# VFS cache pressure (lower = keep more cached objects in RAM)
BOOST_VFS_CACHE_PRESSURE=50
SILENT_VFS_CACHE_PRESSURE=100

# ----------------------------------------------------------------------------
# ZRAM / SWAP MANAGEMENT
# ----------------------------------------------------------------------------

# Clear swap/zram when returning to Silent Mode (frees memory for next load)
CLEAR_SWAP_ON_SILENT=true

# ZRAM compression algorithm preference (lz4 | zstd | lzo-rle)
ZRAM_ALGORITHM="zstd"

# ----------------------------------------------------------------------------
# LOGGING & NOTIFICATIONS
# ----------------------------------------------------------------------------

# Log file location
LOG_FILE="/var/log/power-boost.log"

# Log verbosity: 0=errors only, 1=mode changes, 2=detailed, 3=debug
LOG_LEVEL=2

# Send desktop notifications on mode change (requires notify-send)
DESKTOP_NOTIFICATIONS=true

# Notification timeout in milliseconds
NOTIFY_TIMEOUT=3000

# ----------------------------------------------------------------------------
# SAFETY & LIMITS
# ----------------------------------------------------------------------------

# Maximum time to stay in Boost Mode (seconds, 0 = unlimited)
# Prevents runaway boost if detection gets stuck
MAX_BOOST_DURATION=0

# Thermal throttle: Revert to Silent if GPU temp exceeds this (Celsius)
GPU_THERMAL_LIMIT=85

# CPU thermal limit (Celsius) - revert if any core exceeds this
CPU_THERMAL_LIMIT=95

# ----------------------------------------------------------------------------
# ADVANCED: SCHEDULER TUNING (optional, leave empty to skip)
# ----------------------------------------------------------------------------

# I/O Scheduler for NVMe (none | mq-deadline | kyber | bfq)
# "none" is often best for fast NVMe; "mq-deadline" for mixed workloads
BOOST_IO_SCHEDULER="mq-deadline"
SILENT_IO_SCHEDULER="mq-deadline"

# CPU scheduler hints (requires kernel support)
# SCHED_BATCH for throughput, SCHED_NORMAL for latency
# Leave empty to not modify
BOOST_SCHED_POLICY=""
