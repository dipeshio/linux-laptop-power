#!/bin/bash
# ============================================================================
# WORKLOAD PROFILES CONFIGURATION
# ============================================================================
# Define system-wide profiles for different workloads
# Each profile tunes: CPU, GPU, Memory, Compositor, Process Priority
# ============================================================================

# ============================================================================
# PROFILE: GAMING
# ============================================================================
# Max GPU performance, disable compositor, low-latency audio
# Use for: Games, VR, real-time graphics applications

declare -A PROFILE_GAMING=(
    [description]="Maximum GPU performance for gaming"
    
    # CPU
    [cpu_governor]="performance"
    [cpu_epp]="performance"
    [cpu_boost]="1"
    [cpu_min_perf_pct]="50"
    
    # GPU
    [gpu_power_limit]="220"
    [gpu_clock_min]="1500"
    [gpu_clock_max]="1950"
    [gpu_persistence]="1"
    [gpu_prefer_max_perf]="1"
    
    # Memory
    [swappiness]="10"
    [vfs_cache_pressure]="50"
    [dirty_ratio]="40"
    [dirty_bg_ratio]="10"
    [thp]="madvise"
    
    # Compositor
    [disable_compositor]="1"
    
    # Process
    [nice_level]="-5"
    [ionice_class]="realtime"
    [schedpolicy]="SCHED_RR"
    
    # Audio
    [pulse_latency]="low"
)

# ============================================================================
# PROFILE: AI_ML
# ============================================================================
# Max everything - CPU, GPU, Memory optimized for large model inference
# Use for: Ollama, PyTorch, TensorFlow, LLM inference, training

declare -A PROFILE_AI_ML=(
    [description]="Maximum throughput for AI/ML workloads"
    
    # CPU
    [cpu_governor]="performance"
    [cpu_epp]="performance"
    [cpu_boost]="1"
    [cpu_min_perf_pct]="80"
    
    # GPU
    [gpu_power_limit]="220"
    [gpu_clock_min]="1600"
    [gpu_clock_max]="1950"
    [gpu_persistence]="1"
    [gpu_prefer_max_perf]="1"
    
    # Memory - Aggressive for large models
    [swappiness]="1"
    [vfs_cache_pressure]="50"
    [dirty_ratio]="60"
    [dirty_bg_ratio]="30"
    [thp]="always"
    [compact_memory]="1"
    [drop_caches_before]="1"
    
    # Compositor - keep enabled for monitoring
    [disable_compositor]="0"
    
    # Process
    [nice_level]="-15"
    [ionice_class]="best-effort"
    [schedpolicy]="SCHED_BATCH"
    
    # Extra
    [numa_balancing]="1"
)

# ============================================================================
# PROFILE: CODING
# ============================================================================
# Balanced performance with low latency for IDE responsiveness
# Use for: VS Code, JetBrains, compilation, development

declare -A PROFILE_CODING=(
    [description]="Balanced performance for development work"
    
    # CPU - powersave with good EPP for responsiveness
    [cpu_governor]="powersave"
    [cpu_epp]="balance_performance"
    [cpu_boost]="1"
    [cpu_min_perf_pct]="20"
    
    # GPU - Moderate, enough for UI acceleration
    [gpu_power_limit]="150"
    [gpu_clock_min]="300"
    [gpu_clock_max]="1500"
    [gpu_persistence]="1"
    [gpu_prefer_max_perf]="0"
    
    # Memory - Balanced
    [swappiness]="10"
    [vfs_cache_pressure]="75"
    [dirty_ratio]="30"
    [dirty_bg_ratio]="10"
    [thp]="madvise"
    
    # Compositor - keep for smooth UI
    [disable_compositor]="0"
    
    # Process
    [nice_level]="0"
    [ionice_class]="best-effort"
    [schedpolicy]="SCHED_NORMAL"
)

# ============================================================================
# PROFILE: IDLE
# ============================================================================
# Power saving for browsing, reading, light tasks
# Use for: Web browsing, documents, media consumption

declare -A PROFILE_IDLE=(
    [description]="Power efficient for light workloads"
    
    # CPU - Full powersave
    [cpu_governor]="powersave"
    [cpu_epp]="balance_power"
    [cpu_boost]="1"
    [cpu_min_perf_pct]="10"
    
    # GPU - Minimal
    [gpu_power_limit]="80"
    [gpu_clock_min]="210"
    [gpu_clock_max]="1000"
    [gpu_persistence]="0"
    [gpu_prefer_max_perf]="0"
    
    # Memory - Conservative
    [swappiness]="30"
    [vfs_cache_pressure]="100"
    [dirty_ratio]="20"
    [dirty_bg_ratio]="5"
    [thp]="madvise"
    
    # Compositor
    [disable_compositor]="0"
    
    # Process
    [nice_level]="5"
    [ionice_class]="idle"
    [schedpolicy]="SCHED_IDLE"
)

# ============================================================================
# PROFILE: RENDERING
# ============================================================================
# Max CPU with batch scheduling for video/3D rendering
# Use for: Blender, DaVinci Resolve, FFmpeg, video encoding

declare -A PROFILE_RENDERING=(
    [description]="Maximum throughput for rendering workloads"
    
    # CPU - Max everything
    [cpu_governor]="performance"
    [cpu_epp]="performance"
    [cpu_boost]="1"
    [cpu_min_perf_pct]="100"
    
    # GPU - Max for GPU rendering
    [gpu_power_limit]="220"
    [gpu_clock_min]="1500"
    [gpu_clock_max]="1950"
    [gpu_persistence]="1"
    [gpu_prefer_max_perf]="1"
    
    # Memory - High throughput
    [swappiness]="5"
    [vfs_cache_pressure]="50"
    [dirty_ratio]="50"
    [dirty_bg_ratio]="25"
    [thp]="always"
    
    # Compositor - disable for max resources
    [disable_compositor]="1"
    
    # Process - Batch scheduling for throughput over latency
    [nice_level]="-10"
    [ionice_class]="best-effort"
    [schedpolicy]="SCHED_BATCH"
    
    # Extra
    [affinity_all_cores]="1"
)

# ============================================================================
# PROFILE: AUTO (Default - Workload Detection)
# ============================================================================
# Let the power_boost.sh daemon auto-detect and switch

declare -A PROFILE_AUTO=(
    [description]="Automatic workload detection"
    [mode]="auto"
)

# ============================================================================
# APP-TO-PROFILE MAPPINGS (COMPREHENSIVE)
# ============================================================================
# Automatically detect running apps and suggest/apply profiles
# Patterns are matched against process names using pgrep -if

# GAMING - Games, game launchers, emulators, VR
declare -a GAMING_APPS=(
    # Steam & Proton
    "steam"
    "steamwebhelper"
    "proton"
    "wine-preloader"
    "wineserver"
    "wine64-preloader"
    
    # Game Launchers
    "lutris"
    "heroic"
    "bottles"
    "legendary"
    "gamehub"
    "minigalaxy"
    "itch"
    "gog-galaxy"
    "epic-games"
    "ubisoft"
    "origin"
    "ea-app"
    
    # Native Games / Engines
    "gamescope"
    "gamemode"
    "mangohud"
    "vkBasalt"
    "Godot"
    "Unity"
    "UnrealEngine"
    "UE4Editor"
    "UE5Editor"
    
    # Emulators
    "retroarch"
    "dolphin-emu"
    "yuzu"
    "ryujinx"
    "cemu"
    "rpcs3"
    "pcsx2"
    "ppsspp"
    "desmume"
    "citra"
    "mame"
    "dosbox"
    "fs-uae"
    "hatari"
    "mednafen"
    
    # VR
    "SteamVR"
    "monado"
    "openxr"
    "alvr"
    "vrcompositor"
    
    # Specific Games (common patterns)
    "csgo"
    "dota2"
    "hl2_linux"
    "portal2"
    "tf2"
    "Minecraft"
    "java.*minecraft"
    "factorio"
    "Terraria"
    "Stellaris"
    "CrusaderKings"
    "EuropaUniversalis"
    "Rimworld"
    "Valheim"
    "DeepRockGalactic"
    "Stardew"
    "Celeste"
    "HollowKnight"
    "Hades"
    "Noita"
)

# AI/ML - Machine learning, LLMs, data science
declare -a AI_ML_APPS=(
    # LLM Inference
    "ollama"
    "ollama-runner"
    "llama"
    "llama.cpp"
    "llama-server"
    "llama-cli"
    "llama-bench"
    "vllm"
    "text-generation"
    "localai"
    "lmstudio"
    "gpt4all"
    "koboldcpp"
    "oobabooga"
    "exllama"
    "tabbyml"
    
    # ML Frameworks (Python processes)
    "python.*torch"
    "python.*pytorch"
    "python.*tensorflow"
    "python.*keras"
    "python.*jax"
    "python.*transformers"
    "python.*huggingface"
    "python.*diffusers"
    "python.*accelerate"
    "python.*deepspeed"
    "python.*triton"
    "python.*cuda"
    "python.*xformers"
    
    # AI Applications
    "stable-diffusion"
    "comfyui"
    "automatic1111"
    "invokeai"
    "fooocus"
    "kohya"
    "whisper"
    "faster-whisper"
    "vosk"
    "coqui"
    "bark"
    "tortoise-tts"
    "rvc"
    "so-vits"
    
    # Data Science
    "jupyter"
    "jupyterhub"
    "jupyter-lab"
    "jupyter-notebook"
    "python.*pandas"
    "python.*numpy"
    "python.*scikit"
    "python.*scipy"
    "python.*matplotlib"
    "spyder"
    "rstudio"
    
    # ML Ops
    "mlflow"
    "tensorboard"
    "wandb"
    "neptune"
    "dvc"
    "bentoml"
    "triton-server"
    "torchserve"
    
    # CUDA Tools
    "nvidia-cuda"
    "nvcc"
    "cuda-gdb"
    "nsight"
    "nvtop"
    "nvprof"
)

# CODING - IDEs, editors, compilers, dev tools
declare -a CODING_APPS=(
    # VS Code / Electron IDEs
    "code"
    "codium"
    "code-oss"
    "cursor"
    "zed"
    "windsurf"
    "lapce"
    
    # JetBrains IDEs
    "idea"
    "idea64"
    "pycharm"
    "pycharm64"
    "webstorm"
    "webstorm64"
    "phpstorm"
    "goland"
    "clion"
    "rider"
    "rubymine"
    "datagrip"
    "dataspell"
    "fleet"
    "android-studio"
    
    # Terminal Editors
    "nvim"
    "neovim"
    "vim"
    "emacs"
    "helix"
    "kakoune"
    "micro"
    "nano"
    
    # GUI Editors
    "sublime_text"
    "subl"
    "atom"
    "gedit"
    "kate"
    "kwrite"
    "mousepad"
    "xed"
    "pluma"
    "geany"
    "notepadqq"
    
    # Compilers / Build Tools
    "gcc"
    "g++"
    "clang"
    "rustc"
    "cargo"
    "go"
    "javac"
    "kotlinc"
    "dotnet"
    "msbuild"
    "cmake"
    "make"
    "ninja"
    "meson"
    "bazel"
    "gradle"
    "maven"
    "mvn"
    "ant"
    "npm"
    "yarn"
    "pnpm"
    "bun"
    "deno"
    "node"
    "tsc"
    "esbuild"
    "webpack"
    "vite"
    "rollup"
    "parcel"
    
    # Version Control
    "git"
    "gitk"
    "git-cola"
    "gitkraken"
    "sourcetree"
    "lazygit"
    "tig"
    "gh"
    
    # Debuggers
    "gdb"
    "lldb"
    "valgrind"
    "strace"
    "ltrace"
    "perf"
    
    # Containers / VMs
    "docker"
    "dockerd"
    "containerd"
    "podman"
    "kubernetes"
    "kubectl"
    "minikube"
    "kind"
    "vagrant"
    "qemu"
    "virt-manager"
    "virtualbox"
    "vmware"
    
    # Databases (dev)
    "dbeaver"
    "pgadmin"
    "mysql-workbench"
    "mongodb-compass"
    "redis-commander"
    "robo3t"
    
    # API Tools
    "postman"
    "insomnia"
    "httpie"
    "curl"
    "bruno"
)

# RENDERING - Video editing, 3D, encoding, streaming
declare -a RENDERING_APPS=(
    # Video Editors
    "resolve"
    "davinci"
    "DaVinciResolve"
    "fusion"
    "kdenlive"
    "shotcut"
    "openshot"
    "pitivi"
    "flowblade"
    "olive"
    "cinelerra"
    "lightworks"
    "hitfilm"
    
    # 3D / VFX
    "blender"
    "blender-bin"
    "maya"
    "3dsmax"
    "houdini"
    "cinema4d"
    "c4d"
    "natron"
    "nuke"
    "aftereffects"
    "fusion360"
    "freecad"
    "openscad"
    "meshlab"
    "makehuman"
    "daz3d"
    "poser"
    
    # Motion Graphics
    "synfig"
    "opentoonz"
    "krita"  # When used for animation
    "pencil2d"
    "enve"
    
    # Image Processing (batch)
    "darktable"
    "rawtherapee"
    "digikam"
    "hugin"
    "luminance"
    "imagemagick"
    "convert"
    "mogrify"
    
    # Encoding / Transcoding
    "ffmpeg"
    "ffprobe"
    "HandBrake"
    "ghb"
    "handbrake-cli"
    "avidemux"
    "mkvtoolnix"
    "mkvmerge"
    "x264"
    "x265"
    "svt-av1"
    "nvenc"
    "vaapi"
    "vp9"
    "av1an"
    "tdarr"
    "unmanic"
    "staxrip"
    "shutter-encoder"
    
    # Streaming / Recording
    "obs"
    "obs-studio"
    "streamlabs"
    "vokoscreenNG"
    "simplescreenrecorder"
    "kazam"
    "peek"
    "gpu-screen-recorder"
    "ffplay"
    
    # Audio Production (heavy)
    "ardour"
    "reaper"
    "audacity"
    "lmms"
    "bitwig"
    "renoise"
    "carla"
    "hydrogen"
    "jack"
    "jackd"
    "pipewire-pulse"
    
    # CAD / Engineering
    "autocad"
    "solidworks"
    "inventor"
    "fusion"
    "kicad"
    "librecad"
    "qcad"
    "bricscad"
)

# IDLE - Browsers, media, office, general use
declare -a IDLE_APPS=(
    # Browsers
    "vivaldi"
    "vivaldi-bin"
    "firefox"
    "firefox-esr"
    "chromium"
    "google-chrome"
    "chrome"
    "brave"
    "opera"
    "edge"
    "epiphany"
    "midori"
    "falkon"
    "librewolf"
    "waterfox"
    "floorp"
    "zen-browser"
    
    # Email
    "thunderbird"
    "evolution"
    "geary"
    "mailspring"
    "betterbird"
    "kmail"
    
    # Office
    "libreoffice"
    "soffice"
    "writer"
    "calc"
    "impress"
    "onlyoffice"
    "wps"
    "abiword"
    "gnumeric"
    "calligra"
    
    # PDF / Documents
    "evince"
    "okular"
    "zathura"
    "mupdf"
    "xpdf"
    "calibre"
    "foliate"
    
    # Media Players
    "vlc"
    "mpv"
    "celluloid"
    "totem"
    "parole"
    "smplayer"
    "dragon"
    "mplayer"
    "kodi"
    "plex"
    "jellyfin"
    "stremio"
    
    # Music Players
    "spotify"
    "spotifyd"
    "rhythmbox"
    "clementine"
    "strawberry"
    "lollypop"
    "elisa"
    "amberol"
    "audacious"
    "deadbeef"
    "cmus"
    "mpd"
    "ncmpcpp"
    "tidal"
    "deezer"
    "youtube-music"
    
    # Communication
    "discord"
    "slack"
    "teams"
    "zoom"
    "skype"
    "telegram"
    "signal"
    "element"
    "matrix"
    "whatsapp"
    "franz"
    "ferdi"
    "rambox"
    "jitsi"
    "mumble"
    "teamspeak"
    
    # Social / Reading
    "tweetdeck"
    "cawbird"
    "newsflash"
    "feedreader"
    "liferea"
    "akregator"
    
    # File Managers
    "nautilus"
    "nemo"
    "dolphin"
    "thunar"
    "pcmanfm"
    "spacefm"
    "ranger"
    "lf"
    "mc"
    "doublecmd"
    "krusader"
    
    # Image Viewers
    "eog"
    "feh"
    "imv"
    "sxiv"
    "gthumb"
    "gwenview"
    "ristretto"
    "viewnior"
    "loupe"
    "pix"
    
    # Notes / Tasks
    "obsidian"
    "notion"
    "logseq"
    "joplin"
    "simplenote"
    "standard-notes"
    "turtl"
    "QOwnNotes"
    "cherrytree"
    "zim"
    "tomboy"
    "gnote"
    "todoist"
    "ticktick"
    
    # System Utilities
    "gnome-system-monitor"
    "mate-system-monitor"
    "lxtask"
    "htop"
    "btop"
    "baobab"
    "filelight"
    "gnome-disks"
    "gparted"
    "timeshift"
    
    # Settings
    "gnome-control-center"
    "cinnamon-settings"
    "xfce4-settings"
    "systemsettings"
)

# Legacy flat mapping for compatibility
declare -A APP_PROFILE_MAP=(
    # Gaming shortcuts
    ["steam"]="gaming"
    ["lutris"]="gaming"
    ["wine"]="gaming"
    ["retroarch"]="gaming"
    ["gamescope"]="gaming"
    
    # AI/ML shortcuts
    ["ollama"]="ai_ml"
    ["llama"]="ai_ml"
    ["jupyter"]="ai_ml"
    
    # Coding shortcuts
    ["code"]="coding"
    ["idea"]="coding"
    ["nvim"]="coding"
    
    # Rendering shortcuts
    ["blender"]="rendering"
    ["resolve"]="rendering"
    ["ffmpeg"]="rendering"
    ["obs"]="rendering"
    
    # Idle shortcuts
    ["vivaldi"]="idle"
    ["firefox"]="idle"
    ["spotify"]="idle"
)

# ============================================================================
# HOTKEY BINDINGS (Cinnamon/GNOME compatible)
# ============================================================================

declare -A PROFILE_HOTKEYS=(
    ["gaming"]="<Super><Shift>g"
    ["ai_ml"]="<Super><Shift>a"
    ["coding"]="<Super><Shift>c"
    ["idle"]="<Super><Shift>i"
    ["rendering"]="<Super><Shift>r"
    ["auto"]="<Super><Shift>0"
)

# ============================================================================
# COMPOSITOR COMMANDS
# ============================================================================
# Commands to disable/enable compositor per desktop environment

CINNAMON_COMPOSITOR_OFF="dbus-send --session --dest=org.Cinnamon --type=method_call /org/Cinnamon org.Cinnamon.SetCompositorEnabled boolean:false"
CINNAMON_COMPOSITOR_ON="dbus-send --session --dest=org.Cinnamon --type=method_call /org/Cinnamon org.Cinnamon.SetCompositorEnabled boolean:true"

GNOME_COMPOSITOR_OFF="gsettings set org.gnome.mutter experimental-features \"[]\""
GNOME_COMPOSITOR_ON="gsettings set org.gnome.mutter experimental-features \"['autostart-xwayland']\""

# Detect desktop environment
detect_compositor_commands() {
    if pgrep -x cinnamon &>/dev/null; then
        COMPOSITOR_OFF="$CINNAMON_COMPOSITOR_OFF"
        COMPOSITOR_ON="$CINNAMON_COMPOSITOR_ON"
        echo "cinnamon"
    elif pgrep -x gnome-shell &>/dev/null; then
        COMPOSITOR_OFF="$GNOME_COMPOSITOR_OFF"
        COMPOSITOR_ON="$GNOME_COMPOSITOR_ON"
        echo "gnome"
    else
        COMPOSITOR_OFF=""
        COMPOSITOR_ON=""
        echo "unknown"
    fi
}
