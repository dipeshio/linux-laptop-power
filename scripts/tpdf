#!/bin/bash
# tpdf - Textbook PDF tool
# Usage: 
#   tpdf -n FILE.pdf              Normalize page labels (1, 2, 3...)
#   tpdf FILE.pdf START-END OUT   Extract pages from normalized PDF
# Output goes to ./Segments/ by default

# === Normalize Mode ===
if [[ "$1" == "-n" ]]; then
    PDF_FILE="$2"
    
    if [[ -z "$PDF_FILE" ]]; then
        echo "Usage: tpdf -n FILE.pdf"
        echo "Normalizes page labels to 1, 2, 3..."
        exit 1
    fi
    
    if [[ ! -f "$PDF_FILE" ]]; then
        echo "Error: $PDF_FILE not found"
        exit 1
    fi
    
    # Get page count for progress feedback
    PAGE_COUNT=$(qpdf --show-npages "$PDF_FILE" 2>/dev/null)
    if [[ -z "$PAGE_COUNT" || "$PAGE_COUNT" -eq 0 ]]; then
        echo "Error: Could not determine page count for $PDF_FILE"
        echo "The file may be corrupted or not a valid PDF."
        exit 1
    fi
    
    # Create temp output filename
    BASENAME="${PDF_FILE%.pdf}"
    OUTPUT="${BASENAME}_normalized.pdf"
    
    echo "Normalizing: $PDF_FILE"
    echo "  Total pages: $PAGE_COUNT"
    
    # Progress indicator for large files
    if [[ "$PAGE_COUNT" -gt 75 ]]; then
        echo "  Processing... (this may take a moment for large PDFs)"
    fi
    
    # Set page labels starting from 1 using Arabic numerals (D)
    # Capture both stdout and stderr
    QPDF_OUTPUT=$(qpdf "$PDF_FILE" --set-page-labels '1:D' -- "$OUTPUT" 2>&1)
    QPDF_EXIT=$?
    
    if [[ $QPDF_EXIT -eq 0 ]]; then
        # Replace original with normalized version
        rm "$PDF_FILE"
        mv "$OUTPUT" "$PDF_FILE"
        echo "✓ Normalized $PDF_FILE ($PAGE_COUNT pages, original replaced)"
    else
        echo "✗ qpdf failed (exit code: $QPDF_EXIT)"
        if [[ -n "$QPDF_OUTPUT" ]]; then
            echo "  Error details:"
            echo "$QPDF_OUTPUT" | sed 's/^/    /'
        fi
        # Clean up temp file if it exists
        [[ -f "$OUTPUT" ]] && rm "$OUTPUT"
        exit 1
    fi
    exit 0
fi

# === Extract Mode ===
if [[ $# -lt 3 ]]; then
    echo "Usage:"
    echo "  tpdf -n FILE.pdf              Normalize page labels"
    echo "  tpdf FILE.pdf START-END OUT   Extract pages"
    echo ""
    echo "Example: tpdf MATH280.pdf 19-31 chapter2.pdf"
    exit 1
fi

PDF_FILE="$1"
RANGE="$2"
OUTPUT="$3"

if [[ ! -f "$PDF_FILE" ]]; then
    echo "Error: $PDF_FILE not found"
    exit 1
fi

# Handle output path - default to Segments/
if [[ "$OUTPUT" != */* ]]; then
    mkdir -p Segments
    OUTPUT="Segments/$OUTPUT"
fi

echo "Extracting pages $RANGE from $PDF_FILE → $OUTPUT"

qpdf "$PDF_FILE" --pages . "$RANGE" -- "$OUTPUT"

if [[ $? -eq 0 ]]; then
    echo "✓ Created $OUTPUT"
else
    echo "✗ qpdf failed"
    exit 1
fi
